<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Visualizador de Esqueletos 3D</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>Visualizador de Esqueletos 3D</h1>
        <p>Visualizaci√≥n de datos de captura de movimiento</p>
    </div>
    
    <div class="upload-section">
        <h2>Seleccionar archivo para visualizar</h2>
        <select id="archivoSelect" onchange="cargarYMostrarArchivo(this.value)">
            <option value="">Selecciona un archivo...</option>
        </select>
        <div id="status"></div>
        
        <div class="instructions">
            <p><strong>Instrucciones:</strong> Selecciona un archivo de la lista para visualizar el esqueleto en 3D.</p>
        </div>
    </div>

    <div class="controls" id="animationControls" style="display: none;">
        <button onclick="playAnimation()" id="playBtn" class="control-btn">‚ñ∂ Reproducir</button>
        <button onclick="pauseAnimation()" id="pauseBtn" class="control-btn">‚è∏ Pausar</button>
        <button onclick="stopAnimation()" id="stopBtn" class="control-btn">‚èπ Detener</button>
        
        <div class="control-slider">
            <label>Velocidad: <span id="speedValue">1.0x</span></label>
            <input type="range" id="speedSlider" min="0.1" max="5" step="0.1" value="1" oninput="changeSpeed(this.value)">
        </div>
        
        <div class="control-slider">
            <label>Frame: <span id="frameCounter">0</span>/<span id="totalFrames">0</span></label>
            <input type="range" id="frameSlider" min="0" value="0" oninput="goToFrame(this.value)">
        </div>
    </div>

    <div id="plot3dContainer" class="plot-container">
        <h2>Visualizaci√≥n 3D del Esqueleto</h2>
        <div id="plot3d" class="plot"></div>
    </div>

 <script>
const API_BASE = 'http://127.0.0.1:8000';
const statusEl = document.getElementById('status');
let datosCompletos = [];
let animationInterval = null;
let currentFrame = 0;
let animationSpeed = 1.0;

// Cargar lista de archivos disponibles
async function cargarNombresArchivos() {
    const select = document.getElementById('archivoSelect');
    statusEl.textContent = 'Cargando lista de archivos...';
    try {
        const res = await fetch(`${API_BASE}/lista_archivos/`);
        const archivos = await res.json();
        select.innerHTML = '<option value="">Selecciona un archivo...</option>';
        archivos.forEach(nombre => {
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            select.appendChild(option);
        });
        statusEl.textContent = '';
    } catch (err) {
        statusEl.textContent = 'Error al conectar con el backend';
        statusEl.className = 'error';
    }
}
window.onload = cargarNombresArchivos;

// Cargar y mostrar archivo seleccionado
async function cargarYMostrarArchivo(nombre) {
    if (!nombre) return;
    statusEl.textContent = `Cargando ${nombre}...`;
    try {
        const res = await fetch(`${API_BASE}/data/3d?nombre_archivo=${encodeURIComponent(nombre)}`);
        const datos = await res.json();

        console.log("Datos crudos desde backend:", datos.slice(0, 5)); // üëÄ debug

        datosCompletos = organizarDatosPorFrame(datos);

        if (datosCompletos.length > 0) {
            document.getElementById('animationControls').style.display = 'flex';
            document.getElementById('frameSlider').max = datosCompletos.length - 1;
            document.getElementById('totalFrames').textContent = datosCompletos.length;
            goToFrame(0);
        }
        statusEl.textContent = `Datos cargados: ${datosCompletos.length} frames`;
        statusEl.className = 'success';
    } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error al cargar archivo';
        statusEl.className = 'error';
    }
}

// Organizar datos por frame usando la respuesta de la BD
function organizarDatosPorFrame(datos) {
    const frames = {};
    datos.forEach(item => {
        if (!frames[item.frame_id]) frames[item.frame_id] = [];
        frames[item.frame_id].push({
            segmento: item.segmento, // ahora llega como nombre
            x: item.x,
            y: item.y,
            z: item.z
        });
    });

    console.log("Frames organizados:", frames); // üëÄ debug

    return Object.values(frames);
}

// Ir a un frame espec√≠fico
function goToFrame(frameIndex) {
    currentFrame = parseInt(frameIndex);
    document.getElementById('frameSlider').value = currentFrame;
    document.getElementById('frameCounter').textContent = currentFrame;
    graficarEsqueleto3D(datosCompletos[currentFrame]);
}

// Reproducir animaci√≥n
function playAnimation() {
    if (animationInterval) clearInterval(animationInterval);
    animationInterval = setInterval(() => {
        if (currentFrame >= datosCompletos.length - 1) stopAnimation();
        else goToFrame(currentFrame + 1);
    }, 500 / animationSpeed);
}
function pauseAnimation() { if (animationInterval) clearInterval(animationInterval); }
function stopAnimation() { pauseAnimation(); goToFrame(0); }
function changeSpeed(speed) { 
    animationSpeed = parseFloat(speed); 
    document.getElementById('speedValue').textContent = speed + 'x'; 
}


// Dibujar frame
function graficarEsqueleto3D(frameData) {
    if (!frameData || frameData.length === 0) return;

    // Transformaci√≥n de coordenadas
    const puntos = frameData.map(p => ({
        segmento: p.segmento,
        x: p.x,
        y: p.z,
        z: p.y
    }));

    // Puntos (articulaciones)
    const tracePuntos = {
        x: puntos.map(p => p.x),
        y: puntos.map(p => p.y),
        z: puntos.map(p => p.z),
        mode: 'markers',
        type: 'scatter3d',
        marker: { size: 5, color: 'red' },
        text: puntos.map(p => p.segmento),
        hoverinfo: 'text'
    };

    const conexiones = [
        ["root", "hips"],
        ["hips", "spine"],
        ["spine", "upper_spine"],
        ["upper_spine", "neck"],
        ["neck", "head"],

        ["upper_spine", "left_shoulder"],
        ["upper_spine", "right_shoulder"],
        ["left_shoulder", "left_upper_arm"],
        ["right_shoulder", "right_upper_arm"],
        ["left_upper_arm", "left_lower_arm"],
        ["right_upper_arm", "right_lower_arm"],
        ["left_lower_arm", "left_hand"],
        ["right_lower_arm", "right_hand"],

        ["hips", "left_upper_leg"],
        ["hips", "right_upper_leg"],
        ["left_upper_leg", "left_lower_leg"],
        ["right_upper_leg", "right_lower_leg"],
        ["left_lower_leg", "left_foot"],
        ["right_lower_leg", "right_foot"],
    ];

    const tracesLineas = conexiones.map(([a, b]) => {
        const pa = puntos.find(p => p.segmento === a);
        const pb = puntos.find(p => p.segmento === b);
        if (!pa || !pb) return null;
        return {
            x: [pa.x, pb.x],
            y: [pa.y, pb.y],
            z: [pa.z, pb.z],
            mode: 'lines',
            type: 'scatter3d',
            line: { width: 3, color: 'blue' },
            showlegend: false
        };
    }).filter(Boolean);

    const layout = {
        margin: { l: 0, r: 0, t: 30, b: 0 },
        scene: {
            xaxis: { title: 'X (lado)' },
            yaxis: { title: 'Y (profundidad)' },
            zaxis: { title: 'Z (altura)' },

            aspectmode: "manual",
            aspectratio: { x: 1, y: 1, z: 2 }, 

            camera: {
                eye: { x: 1.5, y: 1.5, z: 1 },
                up: { x: 0, y: 0, z: 1 } 
            }
        }
    };

    Plotly.react('plot3d', [tracePuntos, ...tracesLineas], layout);
}

</script>

</body>
</html>
