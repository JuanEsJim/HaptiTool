<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Visualizador de Esqueletos 3D</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .header { text-align: center; margin-bottom: 20px; }
        .upload-section, .controls, .plot-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; }
        .control-btn { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .control-btn:hover { background-color: #0056b3; }
        .control-slider { display: flex; align-items: center; gap: 10px; }
        .plot { height: 600px; width: 100%; }
        #status { font-style: italic; color: #555; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Visualizador de Esqueletos 3D</h1>
        <p>Visualización de datos de captura de movimiento</p>
    </div>
    
    <div class="upload-section">
        <h2>Seleccionar archivo para visualizar</h2>
        <select id="archivoSelect" onchange="cargarDatos(this.value)">
            <option value="">Selecciona un archivo...</option>
        </select>
        <div id="status"></div>
        <div class="instructions">
            <p><strong>Instrucciones:</strong> Selecciona un archivo de la lista para visualizar el esqueleto en 3D.</p>
        </div>
    </div>

    <div class="controls" id="animationControls" style="display: none;">
        <button onclick="playAnimation()" id="playBtn" class="control-btn">▶ Reproducir</button>
        <button onclick="pauseAnimation()" id="pauseBtn" class="control-btn">⏸ Pausar</button>
        <button onclick="stopAnimation()" id="stopBtn" class="control-btn">⏹ Detener</button>
        
        <div class="control-slider">
            <label>Velocidad: <span id="speedValue">1.0x</span></label>
            <input type="range" id="speedSlider" min="0.1" max="5" step="0.1" value="1" oninput="changeSpeed(this.value)">
        </div>
        
        <div class="control-slider">
            <label>Frame: <span id="frameCounter">0</span>/<span id="totalFrames">0</span></label>
            <input type="range" id="frameSlider" min="0" value="0" oninput="goToFrame(parseInt(this.value))">
        </div>
    </div>

    <div id="plot3dContainer" class="plot-container">
        <h2>Visualización 3D del Esqueleto</h2>
        <div id="plot3d" class="plot"></div>
    </div>

<script>
    const API_BASE = 'http://127.0.0.1:8000';
    let datosCompletos = [];
    let currentFrame = 0;
    let animationInterval = null;
    let animationSpeed = 1.0;
    
    // Nombres de los segmentos del esqueleto. ¡VERIFICADOS CON LA IMAGEN!
    const SKELETON_CONNECTIONS = [
        { parent: "hips", child: "spine" },
        { parent: "spine", child: "upper_spine" },
        { parent: "upper_spine", child: "neck" },
        { parent: "neck", child: "head" },

        { parent: "upper_spine", child: "left_shoulder" },
        { parent: "left_shoulder", child: "left_upper_arm" },
        { parent: "left_upper_arm", child: "left_lower_arm" },
        { parent: "left_lower_arm", child: "left_hand" },

        { parent: "upper_spine", child: "right_shoulder" },
        { parent: "right_shoulder", child: "right_upper_arm" },
        { parent: "right_upper_arm", child: "right_lower_arm" },
        { parent: "right_lower_arm", child: "right_hand" },

        { parent: "hips", child: "left_upper_leg" },
        { parent: "left_upper_leg", child: "left_lower_leg" },
        { parent: "left_lower_leg", child: "left_foot" },
        
        { parent: "hips", child: "right_upper_leg" },
        { parent: "right_upper_leg", child: "right_lower_leg" },
        { parent: "right_lower_leg", child: "right_foot" },
        
        // El segmento 'root' y '_unknown' no tienen conexiones típicas, pero podrían ser el origen.
        // A menudo 'root' está en la misma posición que 'hips'.
        // Si necesitas conectarlos, puedes añadir una línea aquí.
        // { parent: "root", child: "hips" } 
    ];

    async function cargarListaArchivos() {
        const select = document.getElementById('archivoSelect');
        const statusEl = document.getElementById('status');
        statusEl.textContent = 'Cargando lista de archivos...';
        try {
            const res = await fetch(`${API_BASE}/lista_archivos/`);
            if (!res.ok) throw new Error('Error al obtener la lista');
            const archivos = await res.json();
            select.innerHTML = '<option value="">Selecciona un archivo...</option>';
            archivos.forEach(nombre => {
                const option = document.createElement('option');
                option.value = nombre;
                option.textContent = nombre;
                select.appendChild(option);
            });
            statusEl.textContent = '';
        } catch (err) {
            console.error('Error al cargar lista de archivos:', err);
            statusEl.textContent = 'Error al cargar lista de archivos';
        }
    }

    async function cargarDatos(nombreArchivo) {
        if (!nombreArchivo) return;
        stopAnimation(); 
        document.getElementById('status').textContent = `Cargando ${nombreArchivo}...`;
        try {
            const res = await fetch(`${API_BASE}/data/3d?nombre_archivo=${encodeURIComponent(nombreArchivo)}`);
            if (!res.ok) throw new Error('Error al cargar datos del archivo');
            const data = await res.json();
            datosCompletos = data;
            
            document.getElementById('frameSlider').max = datosCompletos.length > 0 ? datosCompletos.length - 1 : 0;
            document.getElementById('totalFrames').textContent = datosCompletos.length;
            document.getElementById('animationControls').style.display = datosCompletos.length > 0 ? 'flex' : 'none';
            
            if (datosCompletos.length > 0) {
                inicializarGrafico(datosCompletos[0]); 
                goToFrame(0);
            } else {
                Plotly.newPlot('plot3d', [], {});
                document.getElementById('status').textContent = 'Archivo sin datos de cinemática';
            }
        } catch (err) {
            console.error("Error al cargar datos:", err);
            document.getElementById('status').textContent = 'Error al cargar datos del archivo';
        }
    }

    function getSegmentCoordinates(frameData, segmentName) {
        const segmentMap = new Map(frameData.map(p => [p.segmento, p]));
        const segment = segmentMap.get(segmentName);
        return segment ? { x: segment.x, y: segment.y, z: segment.z } : null;
    }

    function inicializarGrafico(frameData) {
        if (!frameData || frameData.length === 0) {
            Plotly.newPlot('plot3d', [], {});
            return;
        }

        const x_markers = frameData.map(p => p.x);
        const y_markers = frameData.map(p => p.y);
        const z_markers = frameData.map(p => p.z);
        const labels_markers = frameData.map(p => p.segmento);

        const x_lines = [];
        const y_lines = [];
        const z_lines = [];

        SKELETON_CONNECTIONS.forEach(conn => {
            const parentCoords = getSegmentCoordinates(frameData, conn.parent);
            const childCoords = getSegmentCoordinates(frameData, conn.child);

            if (parentCoords && childCoords) {
                x_lines.push(parentCoords.x, childCoords.x, null);
                y_lines.push(parentCoords.y, childCoords.y, null);
                z_lines.push(parentCoords.z, childCoords.z, null);
            }
        });

        const trace_markers = {
            x: x_markers, y: y_markers, z: z_markers,
            mode: 'markers',
            type: 'scatter3d',
            marker: { size: 6, color: 'red' },
            text: labels_markers,
            hoverinfo: 'text',
            name: 'Articulaciones'
        };

        const trace_lines = {
            x: x_lines, y: y_lines, z: z_lines,
            mode: 'lines',
            type: 'scatter3d',
            line: { width: 4, color: 'blue' },
            name: 'Esqueleto'
        };

        const layout = {
            margin: {l:0, r:0, b:0, t:0},
            scene: {
                xaxis: {title: 'X', autorange: true},
                yaxis: {title: 'Y', autorange: true},
                zaxis: {title: 'Z', autorange: true},
                aspectmode: 'cube'
            },
            showlegend: true
        };

        Plotly.newPlot('plot3d', [trace_markers, trace_lines], layout);
    }
    
    function graficarEsqueleto3D(frameData) {
        if (!frameData || frameData.length === 0) return;

        const x_markers = frameData.map(p => p.x);
        const y_markers = frameData.map(p => p.y);
        const z_markers = frameData.map(p => p.z);

        const x_lines = [];
        const y_lines = [];
        const z_lines = [];

        SKELETON_CONNECTIONS.forEach(conn => {
            const parentCoords = getSegmentCoordinates(frameData, conn.parent);
            const childCoords = getSegmentCoordinates(frameData, conn.child);

            if (parentCoords && childCoords) {
                x_lines.push(parentCoords.x, childCoords.x, null);
                y_lines.push(parentCoords.y, childCoords.y, null);
                z_lines.push(parentCoords.z, childCoords.z, null);
            }
        });

        const update_markers = {
            x: [x_markers],
            y: [y_markers],
            z: [z_markers]
        };

        const update_lines = {
            x: [x_lines],
            y: [y_lines],
            z: [z_lines]
        };
        
        Plotly.restyle('plot3d', update_markers, [0]);
        Plotly.restyle('plot3d', update_lines, [1]);
    }

    function goToFrame(index) {
        if (index >= 0 && index < datosCompletos.length) {
            currentFrame = index;
            graficarEsqueleto3D(datosCompletos[currentFrame]);
            document.getElementById('frameCounter').textContent = (currentFrame + 1) + '/' + datosCompletos.length;
            document.getElementById('frameSlider').value = currentFrame;
        }
    }

    function playAnimation() {
        if (animationInterval) return;
        if (datosCompletos.length === 0) return;

        animationInterval = setInterval(() => {
            currentFrame = (currentFrame + 1) % datosCompletos.length;
            goToFrame(currentFrame);
        }, 1000 / animationSpeed);
    }

    function pauseAnimation() {
        if (animationInterval) {
            clearInterval(animationInterval);
            animationInterval = null;
        }
    }

    function stopAnimation() {
        pauseAnimation();
        currentFrame = 0;
        goToFrame(currentFrame);
    }

    function changeSpeed(speed) {
        animationSpeed = parseFloat(speed);
        document.getElementById('speedValue').textContent = speed + 'x';
        if (animationInterval) {
            pauseAnimation();
            playAnimation();
        }
    }

    window.onload = () => {
        cargarListaArchivos();
    };
</script>

</body>
</html>