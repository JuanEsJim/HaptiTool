<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Panel de Administración</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js      "></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #ffffff;
            color: #333;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .controls,
        .upload-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .control-btn {
            padding: 10px 15px;
            border: none;
            background-color: #005d66;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .control-btn:hover {
            background-color: #0056b3;
        }

        .control-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .plot {
            height: 600px;
            width: 100%;
        }

        #status,
        #uploadStatus {
            font-style: italic;
            color: #555;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Panel de Investigadores</h1>
        <p>Subida y visualización de datos de captura de movimiento</p>
        <button class="logout-btn control-btn" onclick="logout()">Cerrar Sesión</button>
        <button id="createAdminBtn" class="control-btn" style="display: none;">Crear Nuevo Administrador</button>
        <div id="userCountDisplay" style="margin-top: 10px; font-weight: bold;">Cargando usuarios ingresados...</div>
    </div>
    <div id="createAdminForm" class="section" style="display: none;">
        <h3>Crear Nuevo Investigador</h3>
        <form id="newAdminForm">
            <label for="adminName">Nombre:</label><br>
            <input type="text" id="adminName" required><br>
            <label for="adminEmail">Email:</label><br>
            <input type="email" id="adminEmail" required><br>
            <label for="adminPassword">Contraseña:</label><br>
            <input type="password" id="adminPassword" required><br>
            <button type="submit">Crear Investigador</button>
            <p id="adminStatus" style="color: green;"></p>
        </form>
    </div>
    <div class="section">
        <h2>Administrar Archivos</h2>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <input type="text" id="searchAdminInput" placeholder="Buscar archivo..."
                style="padding: 8px; width: 200px;">
            <select id="fileTypeAdminFilter">
                <option value="">Todos los tipos</option>
                <option value="csv">Solo CSV</option>
                <option value="c3d">Solo C3D</option>
            </select>
        </div>
        <div id="adminFilesList" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
    <div class="section">
        <h2>Descargar Archivos</h2>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <input type="text" id="searchDownloadInputAdmin" placeholder="Buscar archivo..."
                style="padding: 8px; width: 200px;">
            <select id="fileTypeDownloadFilterAdmin">
                <option value="">Todos los tipos</option>
                <option value="csv">Solo CSV</option>
                <option value="c3d">Solo C3D</option>
            </select>
        </div>
        <div id="downloadFilesListAdmin" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
    <div class="section upload-section">
        <h2>Subir Archivo</h2>
        <p>Selecciona un archivo CSV o C3D para subir.</p>
        <div class="upload-controls">
            <input type="file" id="fileInput" accept=".csv, .c3d">
            <button class="control-btn" onclick="uploadFile()">Subir Archivo</button>
        </div>
        <div id="uploadStatus"></div>
    </div>
    <div id="gestionUsuariosSection" class="section" style="display: none;">
        <h2>Gestión de Usuarios</h2>
        <button class="control-btn" onclick="cargarListaUsuarios()">↻ Recargar Lista</button>
        <div id="listaUsuariosContainer" style="margin-top: 20px;">

        </div>
    </div>
    <div class="section">
        <h2>Visualizar Datos</h2>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <input type="text" id="searchInput" placeholder="Buscar archivo..." style="padding: 8px; width: 200px;">
            <select id="fileTypeFilter">
                <option value="">Todos los tipos</option>
                <option value="csv">Solo CSV</option>
                <option value="c3d">Solo C3D</option>
            </select>
        </div>
        <select id="archivoSelect" onchange="cargarDatos(this.value)">
            <option value="">Selecciona un archivo...</option>
        </select>
        <div id="status"></div>
    </div>


    <div class="section controls" id="animationControls" style="display: none;">
        <button onclick="playAnimation()" id="playBtn" class="control-btn">▶ Reproducir</button>
        <button onclick="pauseAnimation()" id="pauseBtn" class="control-btn">⏸ Pausar</button>
        <button onclick="stopAnimation()" id="stopBtn" class="control-btn">⏹ Detener</button>

        <div class="control-slider">
            <label>Velocidad: <span id="speedValue">1.0x</span></label>
            <input type="range" id="speedSlider" min="0.1" max="5" step="0.1" value="1"
                oninput="changeSpeed(this.value)">
        </div>

        <div class="control-slider">
            <label>Frame: <span id="frameCounter">0</span>/<span id="totalFrames">0</span></label>
            <input type="range" id="frameSlider" min="0" value="0" oninput="goToFrame(parseInt(this.value))">
        </div>
    </div>

    <div id="plot3dContainer" class="section">
        <h2>Visualización 3D del Esqueleto</h2>
        <div id="plot3d" class="plot"></div>
    </div>

    <div class="section">
        <h2>Historial de Sesiones</h2>
        <button class="control-btn" onclick="location.href='tabla_log.html'">Ver Historial Completo</button>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        const createAdminForm = document.getElementById('createAdminForm');
        const newAdminForm = document.getElementById('newAdminForm');
        const createAdminBtn = document.getElementById('createAdminBtn');
        const adminStatus = document.getElementById('adminStatus');

        let datosCompletos = [];
        let currentFrame = 0;
        let animationInterval = null;
        let animationSpeed = 1.0;

        const SEGMENT_ID_TO_NAME = {
            1: "_unknown",
            2: "root",
            3: "hips",
            4: "left_upper_leg",
            5: "right_upper_leg",
            6: "left_lower_leg",
            7: "right_lower_leg",
            8: "left_foot",
            9: "right_foot",
            10: "spine",
            11: "upper_spine",
            12: "neck",
            13: "head",
            14: "left_shoulder",
            15: "right_shoulder",
            16: "left_upper_arm",
            17: "right_upper_arm",
            18: "left_lower_arm",
            19: "right_lower_arm",
            20: "left_hand",
            21: "right_hand",

        };
        const SEGMENT_NAME_TO_REAL_NAME = {
            "hips": "hips",
            "spine": "spine",
            "upper_spine": "upper_spine",
            "neck": "neck",
            "head": "head",
            "left_shoulder": "left_shoulder",
            "left_upper_arm": "left_upper_arm",
            "left_lower_arm": "left_lower_arm",
            "left_hand": "left_hand",
            "right_shoulder": "right_shoulder",
            "right_upper_arm": "right_upper_arm",
            "right_lower_arm": "right_lower_arm",
            "right_hand": "right_hand",
            "left_upper_leg": "left_upper_leg",
            "left_lower_leg": "left_lower_leg",
            "left_foot": "left_foot",
            "right_upper_leg": "right_upper_leg",
            "right_lower_leg": "right_lower_leg",
            "right_foot": "right_foot",

        };
        const SEGMENT_MAP_C3D = {
            "hips": "hips", "spine": "spine", "upper_spine": "upper_spine", "neck": "neck", "head": "head",
            "left_shoulder": "left_shoulder", "left_upper_arm": "left_upper_arm", "left_lower_arm": "left_lower_arm", "left_hand": "left_hand",
            "right_shoulder": "right_shoulder", "right_upper_arm": "right_upper_arm", "right_lower_arm": "right_lower_arm", "right_hand": "right_hand",
            "left_upper_leg": "left_upper_leg", "left_lower_leg": "left_lower_leg", "left_foot": "left_foot", "right_upper_leg": "right_upper_leg",
            "right_lower_leg": "right_lower_leg", "right_foot": "right_foot",
        };

        const SEGMENT_MAP_CSV = {
            "pelvis": "pelvis", "spine": "spine", "chest": "chest", "neck": "neck", "head": "head",
            "left_shoulder": "left_shoulder", "left_upper_arm": "left_upper_arm", "left_lower_arm": "left_lower_arm", "left_hand": "left_hand",
            "right_shoulder": "right_shoulder", "right_upper_arm": "right_upper_arm", "right_lower_arm": "right_lower_arm", "right_hand": "right_hand",
            "left_upper_leg": "left_upper_leg", "left_lower_leg": "left_lower_leg", "left_foot": "left_foot", "right_upper_leg": "right_upper_leg",
            "right_lower_leg": "right_lower_leg", "right_foot": "right_foot",
        };

        const SKELETON_CONNECTIONS_C3D = [
            { parent: "hips", child: "spine" }, { parent: "spine", child: "upper_spine" }, { parent: "upper_spine", child: "neck" }, { parent: "neck", child: "head" },
            { parent: "upper_spine", child: "left_shoulder" }, { parent: "left_shoulder", child: "left_upper_arm" }, { parent: "left_upper_arm", child: "left_lower_arm" }, { parent: "left_lower_arm", child: "left_hand" },
            { parent: "upper_spine", child: "right_shoulder" }, { parent: "right_shoulder", child: "right_upper_arm" }, { parent: "right_upper_arm", child: "right_lower_arm" }, { parent: "right_lower_arm", child: "right_hand" },
            { parent: "hips", child: "left_upper_leg" }, { parent: "left_upper_leg", child: "left_lower_leg" }, { parent: "left_lower_leg", child: "left_foot" },
            { parent: "hips", child: "right_upper_leg" }, { parent: "right_upper_leg", child: "right_lower_leg" }, { parent: "right_lower_leg", child: "right_foot" },
        ];

        const SKELETON_CONNECTIONS_CSV = [
            { parent: "hips", child: "spine" }, { parent: "spine", child: "upper_spine" }, { parent: "upper_spine", child: "neck" }, { parent: "neck", child: "head" },
            { parent: "upper_spine", child: "left_shoulder" }, { parent: "left_shoulder", child: "left_upper_arm" }, { parent: "left_upper_arm", child: "left_lower_arm" }, { parent: "left_lower_arm", child: "left_hand" },
            { parent: "upper_spine", child: "right_shoulder" }, { parent: "right_shoulder", child: "right_upper_arm" }, { parent: "right_upper_arm", child: "right_lower_arm" }, { parent: "right_lower_arm", child: "right_hand" },
            { parent: "hips", child: "left_upper_leg" }, { parent: "left_upper_leg", child: "left_lower_leg" }, { parent: "left_lower_leg", child: "left_foot" },
            { parent: "hips", child: "right_upper_leg" }, { parent: "right_upper_leg", child: "right_lower_leg" }, { parent: "right_lower_leg", child: "right_foot" },
        ];

        function logout() {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            fetch(`${API_BASE}/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(() => {
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }).catch(err => {
                console.error("Error al cerrar sesión:", err);
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            });
        }

        let user = null; // Variable global

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.detail || 'Error al obtener datos de usuario');
                }

                user = await res.json(); // Guardar el usuario en la variable global

                if (user.rol.nombre === 'admin' || user.rol.nombre === 'super_admin') {
                    cargarListaArchivos();
                    loadUserCount();
                    cargarArchivosParaAdminAdmin(); // Cargar archivos para administrar
                    cargarArchivosParaDescargarAdmin(); // Cargar archivos para descargar
                }

                if (user.rol.nombre === 'super_admin') {
                    createAdminBtn.style.display = 'block';
                    mostrarSeccionGestionUsuarios();
                }

            } catch (err) {
                console.error('Error al verificar el rol del usuario:', err);
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }
        });

        createAdminBtn.addEventListener('click', () => {
            createAdminForm.style.display = createAdminForm.style.display === 'none' ? 'block' : 'none';
        });

        newAdminForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            adminStatus.textContent = '';
            const token = localStorage.getItem('access_token');

            const nombre = document.getElementById('adminName').value;
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;


            if (!nombre || !email || !password) {
                adminStatus.textContent = 'Por favor, completa todos los campos.';
                adminStatus.style.color = 'red';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/create_admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ nombre, email, password })
                });

                const data = await res.json();

                if (!res.ok) {

                    if (data && data.detail) {
                        if (Array.isArray(data.detail)) {
                            const errorMessages = data.detail.map(err => `${err.loc.join('.')}: ${err.msg}`);
                            throw new Error(errorMessages.join(', '));
                        } else {
                            throw new Error(data.detail);
                        }
                    } else {
                        throw new Error('Error al crear administrador');
                    }
                }

                adminStatus.textContent = '¡Administrador creado con éxito!';
                adminStatus.style.color = 'green';
                newAdminForm.reset();
            } catch (err) {
                adminStatus.textContent = err.message;
                adminStatus.style.color = 'red';
            }
        });

        async function loadUserCount() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${API_BASE}/admin/user-count/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                document.getElementById('userCountDisplay').textContent = `Usuarios ingresados: ${data.total_users}`;
            } catch (err) {
                console.error("Error al cargar contador de usuarios:", err);
                document.getElementById('userCountDisplay').textContent = "No se pudo cargar el contador.";
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const statusEl = document.getElementById('uploadStatus');

            if (!file) {
                statusEl.textContent = 'Por favor, selecciona un archivo.';
                return;
            }

            const token = localStorage.getItem('access_token');
            const formData = new FormData();
            formData.append('file', file);


            const extension = file.name.toLowerCase().split('.').pop();
            const endpoint = extension === 'c3d' ? '/upload_c3d/' : '/upload_csv/';

            statusEl.textContent = 'Subiendo archivo...';

            try {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Error al subir el archivo');

                statusEl.textContent = 'Archivo subido con éxito!';
                cargarListaArchivos();
            } catch (err) {
                console.error('Error al subir el archivo:', err);
                statusEl.textContent = `Error al subir el archivo: ${err.message}`;
            }
        }

        async function cargarArchivosParaAdminAdmin() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${API_BASE}/lista_archivos/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Error al obtener la lista de archivos');
                archivosAdminOriginalesAdmin = await res.json();

                filtrarArchivosParaAdminAdmin(); // Aplicar el filtro inicial
            } catch (err) {
                console.error('Error al cargar archivos para administrar:', err);
            }
        }

        let archivosAdminOriginalesAdmin = [];

        function filtrarArchivosParaAdminAdmin() {
            const searchValue = document.getElementById('searchAdminInput').value.toLowerCase();
            const fileTypeFilter = document.getElementById('fileTypeAdminFilter').value;

            let filteredArchivos = archivosAdminOriginalesAdmin.filter(nombre => {
                // Filtrar por tipo de archivo
                if (fileTypeFilter) {
                    const ext = nombre.toLowerCase().split('.').pop();
                    if (ext !== fileTypeFilter) {
                        return false;
                    }
                }

                // Filtrar por nombre (búsqueda parcial)
                if (searchValue) {
                    if (!nombre.toLowerCase().includes(searchValue)) {
                        return false;
                    }
                }

                return true;
            });

            // Actualizar la lista de archivos
            const container = document.getElementById('adminFilesList');
            container.innerHTML = '';

            if (filteredArchivos.length === 0) {
                container.innerHTML = '<p>No se encontraron archivos.</p>';
                return;
            }

            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';

            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
        <th style="border: 1px solid #ddd; padding: 8px;">Nombre del Archivo</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Tipo</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Acción</th>
    `;
            table.appendChild(headerRow);

            filteredArchivos.forEach(nombre => {
                const row = document.createElement('tr');

                const ext = nombre.toLowerCase().split('.').pop();
                const tipo = ext === 'csv' ? 'CSV' : ext === 'c3d' ? 'C3D' : 'Otro';

                // Verificar rol del usuario para mostrar botones
                const eliminarBtn = user.rol.nombre === 'super_admin' ? `<button class="control-btn" onclick="eliminarArchivoAdmin('${nombre}')">Eliminar</button>` : '';
                const actualizarBtn = user.rol.nombre === 'admin' || user.rol.nombre === 'super_admin' ? `<button class="control-btn" onclick="actualizarArchivoAdmin('${nombre}')">Actualizar</button>` : '';

                row.innerHTML = `
            <td style="border: 1px solid #ddd; padding: 8px;">${nombre}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${tipo}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                ${eliminarBtn}
                ${actualizarBtn}
            </td>
        `;
                table.appendChild(row);
            });

            container.appendChild(table);
        }

        function eliminarArchivoAdmin(nombre) {
            if (!confirm(`¿Estás seguro de que deseas eliminar el archivo "${nombre}"?`)) {
                return;
            }

            const token = localStorage.getItem('access_token');
            fetch(`${API_BASE}/archivo/${encodeURIComponent(nombre)}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            })
                .then(res => {
                    if (res.ok) {
                        alert(`Archivo "${nombre}" eliminado correctamente.`);
                        cargarArchivosParaAdminAdmin();
                        cargarArchivosParaDescargarAdmin(); // Actualizar lista de descarga
                        cargarListaArchivos(); // Actualizar lista de visualización
                    } else {
                        return res.json().then(data => { throw new Error(data.detail || 'Error al eliminar archivo'); });
                    }
                })
                .catch(err => {
                    alert('Error: ' + err.message);
                });
        }

        function actualizarArchivoAdmin(nombre) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = nombre.toLowerCase().endsWith('.c3d') ? '.c3d' : '.csv';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                const token = localStorage.getItem('access_token');
                fetch(`${API_BASE}/archivo/${encodeURIComponent(nombre)}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                })
                    .then(res => {
                        if (res.ok) {
                            alert(`Archivo "${nombre}" actualizado correctamente.`);
                            cargarArchivosParaAdminAdmin();
                            cargarArchivosParaDescargarAdmin(); // Actualizar lista de descarga
                            cargarListaArchivos(); // Actualizar lista de visualización
                        } else {
                            return res.json().then(data => { throw new Error(data.detail || 'Error al actualizar archivo'); });
                        }
                    })
                    .catch(err => {
                        alert('Error: ' + err.message);
                    });
            };

            input.click();
        }

        // Agregar listeners a los controles de filtrado
        document.getElementById('searchAdminInput').addEventListener('input', filtrarArchivosParaAdminAdmin);
        document.getElementById('fileTypeAdminFilter').addEventListener('change', filtrarArchivosParaAdminAdmin);
        async function cargarListaArchivos() {
            const statusEl = document.getElementById('status');
            const token = localStorage.getItem('access_token');
            statusEl.textContent = 'Cargando lista de archivos...';
            try {
                const res = await fetch(`${API_BASE}/lista_archivos/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Error al obtener la lista');
                archivosOriginales = await res.json(); // Guardar la lista original

                filtrarArchivos(); // Aplicar el filtro inicial (mostrar todos)
                statusEl.textContent = '';
            } catch (err) {
                console.error('Error al cargar lista de archivos:', err);
                statusEl.textContent = 'Error al cargar lista de archivos';
            }
        }

        let archivosOriginales = []; // Almacenar la lista completa de archivos

        function filtrarArchivos() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const fileTypeFilter = document.getElementById('fileTypeFilter').value;

            let filteredArchivos = archivosOriginales.filter(nombre => {
                // Filtrar por tipo de archivo
                if (fileTypeFilter) {
                    const ext = nombre.toLowerCase().split('.').pop();
                    if (ext !== fileTypeFilter) {
                        return false;
                    }
                }

                // Filtrar por nombre 
                if (searchValue) {
                    if (!nombre.toLowerCase().includes(searchValue)) {
                        return false;
                    }
                }

                return true;
            });

            // Actualizar el select con los archivos filtrados
            const select = document.getElementById('archivoSelect');
            select.innerHTML = '<option value="">Selecciona un archivo...</option>';
            filteredArchivos.forEach(nombre => {
                const option = document.createElement('option');
                option.value = nombre;
                option.textContent = nombre;
                select.appendChild(option);
            });
        }

        // Agregar listeners a los controles de filtrado
        document.getElementById('searchInput').addEventListener('input', filtrarArchivos);
        document.getElementById('fileTypeFilter').addEventListener('change', filtrarArchivos);
        async function cargarArchivosParaDescargarAdmin() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${API_BASE}/lista_archivos/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Error al obtener la lista de archivos');
                archivosDescargaOriginalesAdmin = await res.json();

                filtrarArchivosParaDescargaAdmin(); // Aplicar el filtro inicial
            } catch (err) {
                console.error('Error al cargar archivos para descargar:', err);
            }
        }

        let archivosDescargaOriginalesAdmin = [];

        function filtrarArchivosParaDescargaAdmin() {
            const searchValue = document.getElementById('searchDownloadInputAdmin').value.toLowerCase();
            const fileTypeFilter = document.getElementById('fileTypeDownloadFilterAdmin').value;

            let filteredArchivos = archivosDescargaOriginalesAdmin.filter(nombre => {
                // Filtrar por tipo de archivo
                if (fileTypeFilter) {
                    const ext = nombre.toLowerCase().split('.').pop();
                    if (ext !== fileTypeFilter) {
                        return false;
                    }
                }

                // Filtrar por nombre
                if (searchValue) {
                    if (!nombre.toLowerCase().includes(searchValue)) {
                        return false;
                    }
                }

                return true;
            });

            // Actualizar la lista de archivos
            const container = document.getElementById('downloadFilesListAdmin');
            container.innerHTML = '';

            if (filteredArchivos.length === 0) {
                container.innerHTML = '<p>No se encontraron archivos.</p>';
                return;
            }

            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';

            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <th style="border: 1px solid #ddd; padding: 8px;">Nombre del Archivo</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Tipo</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Acción</th>
            `;
            table.appendChild(headerRow);

            filteredArchivos.forEach(nombre => {
                const row = document.createElement('tr');

                const ext = nombre.toLowerCase().split('.').pop();
                const tipo = ext === 'csv' ? 'CSV' : ext === 'c3d' ? 'C3D' : 'Otro';

                row.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${nombre}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${tipo}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <button class="control-btn" onclick="descargarArchivoAdmin('${nombre}')">Descargar</button>
                    </td>
                `;
                table.appendChild(row);
            });

            container.appendChild(table);
        }
        function mostrarSeccionGestionUsuarios() {
            const seccion = document.getElementById('gestionUsuariosSection');
            if (user && user.rol.nombre === 'super_admin') {
                seccion.style.display = 'block';
                cargarListaUsuarios(); // Cargar la lista automáticamente al mostrar la sección
            } else {
                seccion.style.display = 'none';
            }
        }

        /**
         * Obtiene la lista de usuarios desde el backend y la muestra en una tabla linea 816
         */
        async function cargarListaUsuarios() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('listaUsuariosContainer');
            container.innerHTML = '<p>Cargando usuarios...</p>';

            try {
                const res = await fetch(`${API_BASE}/admin/users/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    }
                });

                if (!res.ok) {
                    if (res.status === 403) {
                        throw new Error("Acceso denegado. Solo superadministradores pueden acceder.");
                    }
                    const errorData = await res.json();
                    throw new Error(errorData.detail || `Error al obtener la lista de usuarios (${res.status})`);
                }

                const usuarios = await res.json();

                if (!Array.isArray(usuarios) || usuarios.length === 0) {
                    container.innerHTML = '<p>No se encontraron usuarios.</p>';
                    return;
                }

               // se contruye la tabla HTML
                let tablaHTML = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="border: 1px solid #ddd; padding: 8px;">ID</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Nombre</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Email</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Rol</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
        `;

                usuarios.forEach(u => {
                   
                    const acciones = u.usuario_id === user.usuario_id ?
                        `<em>(Tú)</em>` :
                        `
                <button class="control-btn" style="margin-right: 5px;" onclick="abrirModalActualizarPassword(${u.usuario_id}, '${u.nombre}')">Cambiar Contraseña</button>
                <button class="control-btn" style="background-color: #d32f2f;" onclick="eliminarUsuario(${u.usuario_id}, '${u.nombre}')">Eliminar</button>
                `;

                    tablaHTML += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${u.usuario_id}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${u.nombre}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${u.email}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${u.rol ? u.rol.nombre : 'Sin rol'}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${acciones}</td>
                </tr>
            `;
                });

                tablaHTML += `
            </tbody>
        </table>
        `;

                container.innerHTML = tablaHTML;

            } catch (err) {
                console.error("Error al cargar la lista de usuarios:", err);
                container.innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
            }
        }

        /**
         * Solicita la nueva contraseña y la envía al backend para actualizarla.
         */
        function abrirModalActualizarPassword(usuarioId, nombreUsuario) {
            const nuevaPass = prompt(`Ingrese la nueva contraseña para el usuario "${nombreUsuario}":`);
            if (nuevaPass !== null && nuevaPass.trim() !== '') {
                actualizarPasswordUsuario(usuarioId, nuevaPass.trim());
            } else if (nuevaPass !== null) {
                alert("La contraseña no puede estar vacía.");
            }
            // Si es null, el usuario canceló, no hacer nada.
        }

        async function actualizarPasswordUsuario(usuarioId, nuevaPassword) {
            const token = localStorage.getItem('access_token');

            try {
                const res = await fetch(`${API_BASE}/admin/users/${usuarioId}/password`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ new_password: nuevaPassword }) // El back espera este formato 
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.detail || `Error al actualizar la contraseña (${res.status})`);
                }

                const data = await res.json();
                alert(data.message || 'Contraseña actualizada correctamente.');
                // cargarListaUsuarios();

            } catch (err) {
                console.error("Error al actualizar contraseña:", err);
                alert(`Error: ${err.message}`);
            }
        }


        /**
         * Confirma y solicita la eliminación de un usuario.
         */
        function eliminarUsuario(usuarioId, nombreUsuario) {
           
            if (usuarioId === user.usuario_id) {
                alert("No puedes eliminarte a ti mismo.");
                return;
            }

            if (confirm(`¿Estás seguro de que deseas eliminar al usuario "${nombreUsuario}" (ID: ${usuarioId})? Esta acción no se puede deshacer.`)) {
                eliminarUsuarioBackend(usuarioId);
            }
        }

        async function eliminarUsuarioBackend(usuarioId) {
            const token = localStorage.getItem('access_token');

            try {
                const res = await fetch(`${API_BASE}/admin/users/${usuarioId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        
                    }
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.detail || `Error al eliminar el usuario (${res.status})`);
                }

                const data = await res.json();
                alert(data.message || 'Usuario eliminado correctamente.');
                // Recargar la lista de usuarios después de eliminar
                cargarListaUsuarios();

            } catch (err) {
                console.error("Error al eliminar usuario:", err);
                alert(`Error: ${err.message}`);
            }
        }
        function descargarArchivoAdmin(nombre) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('No se encontró el token de acceso. Por favor, inicia sesión nuevamente.');
                window.location.href = 'login.html';
                return;
            }

            // Crear la URL base sin el token como parámetro
            const baseUrl = `${API_BASE}/download/${encodeURIComponent(nombre)}`;

            // Usar fetch para manejar la descarga con header de autorización
            fetch(baseUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                   
                }
            })
                .then(response => {
                    if (!response.ok) {
                        // Intenta leer el mensaje de error del backend
                        return response.text().then(text => {
                            let errorMsg;
                            try {
                                const errorData = JSON.parse(text);
                                errorMsg = errorData.detail || `Error ${response.status} `;
                            } catch (e) {
                                errorMsg = text || `Error ${response.status} `;
                            }
                            throw new Error(errorMsg);
                        });
                    }
                    // Obtener el nombre del archivo del header 'content-disposition' si está presente
                    // o usar el nombre original
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = nombre; // Valor por defecto
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                        if (filenameMatch.length === 2) {
                            filename = filenameMatch[1];
                        }
                    }

                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    // Crear un enlace temporal para descargar el blob
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename; // Nombre del archivo para la descarga

                    document.body.appendChild(a);
                    a.click(); // Hacer clic en el enlace
                    document.body.removeChild(a);

                    // Liberar el objeto URL
                    window.URL.revokeObjectURL(url);
                })
                .catch(async (error) => {
                    console.error('Error al descargar el archivo:', error);

                    if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                        alert('Tu sesión ha expirado. Por favor, inicia sesión nuevamente.');
                        localStorage.removeItem('access_token');
                        window.location.href = 'login.html';
                    } else {
                        alert(`Error al descargar el archivo: ${error.message} `);
                    }
                });
        }


        function getSegmentCoordinates(frameData, skeletonName, fileType) {
            const segmentMap = new Map(frameData.map(p => [p.segmento, p]));

            // Si es CSV, busca por nombre
            if (fileType === "csv") {
                const segment = segmentMap.get(skeletonName);
                if (segment && segment.x !== undefined && segment.y !== undefined && segment.z !== undefined) {
                    return { x: segment.x, y: segment.y, z: segment.z };
                }
                return null;
            }

            // Si es C3D, busca por nombre
            let segment = segmentMap.get(skeletonName);

            if (!segment) {
                const c3dName = Object.keys(SEGMENT_MAP_C3D).find(key => SEGMENT_MAP_C3D[key] === skeletonName);
                if (c3dName) {
                    segment = segmentMap.get(c3dName);
                }
            }

            if (segment && segment.x !== undefined && segment.y !== undefined && segment.z !== undefined) {
                return { x: segment.x, y: segment.y, z: segment.z };
            }

            return null;
        }


        function inicializarGrafico(frameData, fileType) {
            if (!frameData || frameData.length === 0) {
                Plotly.newPlot('plot3d', [], {});
                return;
            }

            const filteredFrameData = frameData;


            const x_markers = filteredFrameData.map(p => p.x);
            const y_markers = filteredFrameData.map(p => p.y);
            const z_markers = filteredFrameData.map(p => p.z);
            const labels_markers = filteredFrameData.map(p => {

                if (typeof p.segmento === "number") {
                    return SEGMENT_ID_TO_NAME[p.segmento] || `_unknown(${p.segmento})`;
                }

                return p.segmento || "_unknown";
            });

            const x_lines = [];
            const y_lines = [];
            const z_lines = [];

            const skeletonConnections = fileType === "csv" ? SKELETON_CONNECTIONS_CSV : SKELETON_CONNECTIONS_C3D;

            skeletonConnections.forEach(conn => {
                const parentCoords = getSegmentCoordinates(filteredFrameData, conn.parent, fileType);
                const childCoords = getSegmentCoordinates(filteredFrameData, conn.child, fileType);
                if (parentCoords && childCoords) {
                    x_lines.push(parentCoords.x, childCoords.x, null);
                    y_lines.push(parentCoords.y, childCoords.y, null);
                    z_lines.push(parentCoords.z, childCoords.z, null);
                }
            });

            const trace_markers = {
                x: x_markers, y: y_markers, z: z_markers,
                mode: 'markers',
                type: 'scatter3d',
                marker: { size: 6, color: 'red' },
                text: labels_markers,
                textposition: 'top center',
                hoverinfo: 'text',
                name: 'Articulaciones'
            };

            const trace_lines = {
                x: x_lines, y: y_lines, z: z_lines,
                mode: 'lines',
                type: 'scatter3d',
                line: { width: 4, color: 'blue' },
                name: 'Esqueleto'
            };

            const layout = {
                margin: { l: 0, r: 0, b: 0, t: 0 },
                scene: {
                    xaxis: { title: 'X', autorange: true },
                    yaxis: { title: 'Y', autorange: true },
                    zaxis: { title: 'Z', autorange: true },
                    aspectmode: 'cube'
                },
                showlegend: true
            };

            Plotly.newPlot('plot3d', [trace_markers, trace_lines], layout);
        }
        function graficarEsqueleto3D(frameData) {
            if (!frameData) return;

            const x_markers = frameData.map(p => p.x);
            const y_markers = frameData.map(p => p.y);
            const z_markers = frameData.map(p => p.z);

            const x_lines = [];
            const y_lines = [];
            const z_lines = [];


            const fileType = datosCompletos.fileType || "c3d";
            const skeletonConnections = fileType === "c3d" ? SKELETON_CONNECTIONS_C3D : SKELETON_CONNECTIONS_CSV;

            skeletonConnections.forEach(conn => {
                const parentCoords = getSegmentCoordinates(frameData, conn.parent, fileType);
                const childCoords = getSegmentCoordinates(frameData, conn.child, fileType);

                if (parentCoords && childCoords) {
                    x_lines.push(parentCoords.x, childCoords.x, null);
                    y_lines.push(parentCoords.y, childCoords.y, null);
                    z_lines.push(parentCoords.z, childCoords.z, null);
                }
            });

            Plotly.restyle('plot3d', { x: [x_markers], y: [y_markers], z: [z_markers] }, [0]);
            Plotly.restyle('plot3d', { x: [x_lines], y: [y_lines], z: [z_lines] }, [1]);
        }


        function goToFrame(index) {
            if (index >= 0 && index < datosCompletos.length) {
                currentFrame = index;
                graficarEsqueleto3D(datosCompletos[currentFrame]);
                document.getElementById('frameCounter').textContent = (currentFrame + 1) + '/' + datosCompletos.length;
                document.getElementById('frameSlider').value = currentFrame;
            }
        }

        function playAnimation() {
            if (animationInterval) return;
            if (datosCompletos.length === 0) return;
            animationInterval = setInterval(() => {
                currentFrame = (currentFrame + 1) % datosCompletos.length;
                goToFrame(currentFrame);
            }, 1000 / animationSpeed);
        }

        function pauseAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        }

        function stopAnimation() {
            pauseAnimation();
            currentFrame = 0;
            goToFrame(currentFrame);
        }

        function changeSpeed(speed) {
            animationSpeed = parseFloat(speed);
            document.getElementById('speedValue').textContent = speed + 'x';
            if (animationInterval) {
                pauseAnimation();
                playAnimation();
            }
        }
    </script>
</body>

</html>